<!DOCTYPE html>

<html>
<head>
  <title>models.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="models.html">
                models.js
              </a>
            
              
              <a class="source" href="views.html">
                views.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>models.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> app = <span class="hljs-built_in">window</span>.app || {};

app.ApplicationSession = Backbone.Model.extend({
    defaults: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> {
            username: <span class="hljs-literal">null</span>,
            repositories: <span class="hljs-literal">null</span>,
            gitHubUser: <span class="hljs-literal">null</span>,
            lastRefreshed: <span class="hljs-literal">null</span>,
            baseContainer:<span class="hljs-string">"#appContainer"</span>,
            totalRepositoryCount: <span class="hljs-literal">null</span>,
            rateLimit: <span class="hljs-keyword">new</span> app.RateLimit(),
            preloaded: <span class="hljs-literal">false</span>
        };
    },
    validate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attributes)</span> </span>{
        <span class="hljs-keyword">if</span> (!attributes.baseContainer) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"The application requires a selector for a DOM element in which it should render."</span>;
        }
    },
    createChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

        <span class="hljs-keyword">var</span> username = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">"username"</span>);

        <span class="hljs-keyword">if</span> (!username) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">var</span> gitHubUser = <span class="hljs-keyword">new</span> app.GitHubUser({login: username});
        <span class="hljs-keyword">this</span>.set(<span class="hljs-string">"gitHubUser"</span>, gitHubUser);

        <span class="hljs-keyword">var</span> repositories = <span class="hljs-keyword">new</span> app.RepositoryCollection([], {gitHubUser: gitHubUser, owner: <span class="hljs-keyword">this</span>});
        <span class="hljs-keyword">this</span>.set(<span class="hljs-string">"repositories"</span>, repositories);

        <span class="hljs-keyword">this</span>.listenTo(repositories, <span class="hljs-string">"syncAllPages"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(syncResult)</span> </span>{
            that.set(<span class="hljs-string">"totalRepositoryCount"</span>, syncResult.totalItemsLoaded);
        });

        <span class="hljs-keyword">var</span> rateLimit = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">"rateLimit"</span>);
        rateLimit.observeRateLimitedObject(repositories);
        rateLimit.observeRateLimitedObject(gitHubUser);
    },
    switchUser: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(newUsername)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Ideally we’ll replace the session instance with a new one.
But since this is still a single instance style session, we’ll just update it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">this</span>.stopListening();
        <span class="hljs-keyword">this</span>.set({
            username: newUsername,
            preloaded:<span class="hljs-literal">false</span>,
            repositories:<span class="hljs-literal">null</span>,
            gitHubUser:<span class="hljs-literal">null</span>,
            lastRefreshed:<span class="hljs-literal">null</span>,
            totalRepositoryCount: <span class="hljs-literal">null</span>
        });

        <span class="hljs-keyword">this</span>.createChildren();

        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"switchedUser"</span>);

    },
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.createChildren();
    }
});

app.RepositoryLanguageDetails = Backbone.Model.extend({
    url: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.id) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"A repository id is required before its languages can be loaded."</span>);
        }

        <span class="hljs-keyword">var</span> owner= <span class="hljs-keyword">this</span>.get(<span class="hljs-string">"owner"</span>);

        <span class="hljs-keyword">if</span> (!owner) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"A repository owner username is required before its languages can be loaded."</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-string">"https://api.github.com/repos/"</span> + owner + <span class="hljs-string">"/"</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">"/languages"</span>;
    },
    parseLanguageObject: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> </span>{

        <span class="hljs-keyword">var</span> totalBytes = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> languageData = _.map(response, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(byteLength, languageName)</span> </span>{
            totalBytes += byteLength;
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"languageName"</span>:languageName, <span class="hljs-string">"byteLength"</span>:byteLength};
        });

        <span class="hljs-keyword">if</span> (!languageData.length) {
            <span class="hljs-keyword">return</span> [];
        }

        languageData = _.each(languageData, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(language)</span> </span>{
            language.percentageFloat = (language.byteLength / totalBytes) * <span class="hljs-number">100</span>;
            language.percentage = ((<span class="hljs-built_in">Math</span>.round(<span class="hljs-number">10</span>*language.percentageFloat)/<span class="hljs-number">10</span>).toFixed(<span class="hljs-number">1</span>).toString()) * <span class="hljs-number">1</span>;

        });

        <span class="hljs-keyword">var</span> getRemainder = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(languages)</span> </span>{

            <span class="hljs-keyword">var</span> off = <span class="hljs-number">100</span> - _.reduce(languages, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(acc, language)</span> </span>{
                    <span class="hljs-keyword">return</span> acc + language.percentage;
                }, <span class="hljs-number">0</span>);

            off = (<span class="hljs-built_in">Math</span>.round(<span class="hljs-number">10</span>*off)/<span class="hljs-number">10</span>).toFixed(<span class="hljs-number">1</span>).toString() * <span class="hljs-number">1</span>;

            <span class="hljs-keyword">return</span> off;

        };

        <span class="hljs-keyword">var</span> remainder = getRemainder(languageData);

        languageData[<span class="hljs-number">0</span>].percentage += remainder; <span class="hljs-comment">// Could probably allocate the remainder a little more accuratly.</span>

        <span class="hljs-keyword">return</span> languageData;
    },
    setLanguageObject: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> </span>{
        <span class="hljs-keyword">var</span> languageData = <span class="hljs-keyword">this</span>.parseLanguageObject(model);
        <span class="hljs-keyword">this</span>.set(<span class="hljs-string">"languageData"</span>, languageData);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },
    defaults: {
        languageData:<span class="hljs-literal">null</span>,
        owner: <span class="hljs-literal">null</span>
    },
    isFetched: <span class="hljs-literal">false</span>,
    isFetching: <span class="hljs-literal">false</span>,
    parse: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> </span>{

        response.languageData = <span class="hljs-keyword">this</span>.parseLanguageObject(response);
        response.id = <span class="hljs-keyword">this</span>.id;
        response.owner = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">"owner"</span>);

        <span class="hljs-keyword">return</span> response;
    },
    withUrl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(url)</span> </span>{
        <span class="hljs-keyword">this</span>.url = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
           <span class="hljs-keyword">return</span> url;
        };
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.parse;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },
    processRateLimits: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
        <span class="hljs-keyword">if</span> (!xhr) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"rateLimitedXHRComplete"</span>, xhr);
    },
    fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isFetching) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">this</span>.isFetching = <span class="hljs-literal">true</span>;
        options = options ? _.clone(options) : {};
        <span class="hljs-keyword">var</span> success = options.success;
        <span class="hljs-keyword">var</span> error = options.error;
        <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">this</span>;

        options.success = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, response, options)</span> </span>{
            model.isFetched =  <span class="hljs-literal">true</span>;
            model.isFetching = <span class="hljs-literal">false</span>;
            model.fetchError = <span class="hljs-literal">false</span>;
            model.processRateLimits(options.xhr);
            <span class="hljs-keyword">if</span> (success) success(model, response, options);
        };

        options.error = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, response, options)</span> </span>{
            model.isFetched =  <span class="hljs-literal">true</span>;
            model.isFetching = <span class="hljs-literal">false</span>;
            model.fetchError = <span class="hljs-literal">true</span>;
            model.processRateLimits(response);
            <span class="hljs-keyword">if</span> (error) error(model, response, options);
        };

        <span class="hljs-keyword">return</span> Backbone.Model.prototype.fetch.call(<span class="hljs-keyword">this</span>, options);
    }
});

app.Repository = Backbone.Model.extend({
    getLanguageModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> app.RepositoryLanguageDetails().withUrl(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">"languages_url"</span>));
    },
    defaults: {
        stargazers_count:<span class="hljs-number">0</span>,
        watchers_count:<span class="hljs-number">0</span>
    }
});

app.Error = Backbone.Model.extend({
    defaults: {
        message:<span class="hljs-string">"Sorry, an error has occoured..."</span>
    }
});

app.RateLimit = Backbone.Model.extend({
    defaults: {
        requestLimit: <span class="hljs-literal">null</span>,
        requestLimitRemaining:<span class="hljs-literal">null</span>,
        requestLimitExpires: <span class="hljs-literal">null</span>, <span class="hljs-comment">// &lt; Intented to be a DateTime/moment</span>
        requestLimitReset: <span class="hljs-literal">null</span> <span class="hljs-comment">// &lt; Intented to be the unix EPOCH.</span>
    },
    triggerRateLimitUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(requestLimit, requestLimitRemaining, requestLimitReset)</span> </span>{
        <span class="hljs-keyword">if</span> (requestLimit !== <span class="hljs-literal">null</span> || requestLimitRemaining !== <span class="hljs-literal">null</span> || requestLimitReset !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> fetchResult = {
                requestLimit: requestLimit,
                requestLimitRemaining:requestLimitRemaining,
                requestLimitReset: requestLimitReset,
                requestLimitExpires: moment.unix(requestLimitReset)
            };

            <span class="hljs-keyword">this</span>.set(fetchResult);
            <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"rateLimitUpdated"</span>, fetchResult);
        }
    },
    processLimitsFromXHR: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

        <span class="hljs-keyword">if</span> (!xhr) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">var</span> requestLimit = xhr.getResponseHeader(<span class="hljs-string">'X-RateLimit-Limit'</span>);
        <span class="hljs-keyword">var</span> requestLimitRemaining = xhr.getResponseHeader(<span class="hljs-string">'X-RateLimit-Remaining'</span>);
        <span class="hljs-keyword">var</span> requestLimitReset = xhr.getResponseHeader(<span class="hljs-string">'X-RateLimit-Reset'</span>);

        <span class="hljs-keyword">if</span> (requestLimit !== <span class="hljs-literal">null</span>) {
            requestLimit  = requestLimit * <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">if</span> (requestLimitRemaining !== <span class="hljs-literal">null</span>) {
            requestLimitRemaining  = requestLimitRemaining * <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">if</span> (requestLimitReset !== <span class="hljs-literal">null</span>) {
            requestLimitReset  = requestLimitReset * <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">this</span>.triggerRateLimitUpdate(requestLimit, requestLimitRemaining, requestLimitReset);

    },
    observeRateLimitedObject: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
        <span class="hljs-keyword">this</span>.listenTo(obj, <span class="hljs-string">"rateLimitedXHRComplete"</span>, <span class="hljs-keyword">this</span>.processLimitsFromXHR);
    }
});

app.GitHubUser = Backbone.Model.extend({
    defaults: {
        name:<span class="hljs-string">""</span>,
        login:<span class="hljs-string">""</span> <span class="hljs-comment">// &lt; This is the username, but for this endpoint only, it's called login instead.</span>
    },
    url: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> login = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">"login"</span>);

        <span class="hljs-keyword">if</span> (!login) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot get a users profile without their username."</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-string">"https://api.github.com/users/"</span> + login;
    },
    processRateLimits: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
        <span class="hljs-keyword">if</span> (!xhr) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"rateLimitedXHRComplete"</span>, xhr);
    },
    fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
        options = options ? _.clone(options) : {};

        <span class="hljs-keyword">var</span> complete = options.complete;
        <span class="hljs-keyword">var</span> error = options.error;
        <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">this</span>;

        options.complete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(jqXHR, textStatus)</span> </span>{
            model.processRateLimits(jqXHR);
            <span class="hljs-keyword">if</span> (complete) complete(jqXHR, textStatus);
        };

        options.error = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, response, options)</span> </span>{
            model.processRateLimits(response);
            <span class="hljs-keyword">if</span> (error) error(model, response, options);
        };

        <span class="hljs-keyword">return</span> Backbone.Model.prototype.fetch.call(<span class="hljs-keyword">this</span>, options);
    }
});

app.RepositoryCollection = Backbone.Collection.extend({
    url: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> username = <span class="hljs-keyword">this</span>.options.gitHubUser.get(<span class="hljs-string">"login"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"https://api.github.com/users/"</span> + username + <span class="hljs-string">"/repos?type=all&amp;per_page="</span> + <span class="hljs-keyword">this</span>.options.perPage;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Comma separated list of attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sortColumn: <span class="hljs-string">"stargazers_count,watchers_count"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Comma separated list corresponding to column list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sortDirection: <span class="hljs-string">'desc,desc'</span>, <span class="hljs-comment">// - [ 'asc'|'desc' ]</span>
    comparator: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( a, b )</span> </span>{

        <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.sortColumn ) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">var</span> cols = <span class="hljs-keyword">this</span>.sortColumn.split( <span class="hljs-string">','</span> ),
            dirs = <span class="hljs-keyword">this</span>.sortDirection.split( <span class="hljs-string">','</span> ),
            cmp;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>First column that does not have equal values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cmp = _.find( cols, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( c )</span> </span>{ <span class="hljs-keyword">return</span> a.attributes[c] != b.attributes[c]; });</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>undefined means they’re all equal, so we’re done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( !cmp ) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Otherwise, use that column to determine the order
match the column sequence to the methods for ascending/descending
default to ascending when not defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( ( dirs[_.indexOf( cols, cmp )] || <span class="hljs-string">'asc'</span> ).toLowerCase() == <span class="hljs-string">'asc'</span> ) {
            <span class="hljs-keyword">return</span> a.attributes[cmp] &gt; b.attributes[cmp] ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> a.attributes[cmp] &lt; b.attributes[cmp] ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
        }

    },
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models, options)</span> </span>{

        <span class="hljs-keyword">if</span> (!options) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"A RepositoryCollection requires an options object."</span>);
        }

        <span class="hljs-keyword">this</span>.options = options;

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.options.gitHubUser) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"A RepositoryCollection requires an owner (a GitHubUser object) to be set in its options."</span>);
        }

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.options.perPage) {
            <span class="hljs-keyword">this</span>.options.perPage = <span class="hljs-number">100</span>;
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.options.page) {
            <span class="hljs-keyword">this</span>.options.page = <span class="hljs-number">1</span>;
        }
    },
    currentXhr: <span class="hljs-literal">null</span>,
    processRateLimits: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
        <span class="hljs-keyword">if</span> (!xhr) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"rateLimitedXHRComplete"</span>, xhr);
    },
    parseLinkHeader: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(header, currentPage)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Example header:
<a href="https://api.github.com/user/1/repos?type=all&amp;page=3&amp;per_page=100">https://api.github.com/user/1/repos?type=all&amp;page=3&amp;per_page=100</a>; rel=”next”,
<a href="https://api.github.com/user/1/repos?type=all&amp;page=3&amp;per_page=100">https://api.github.com/user/1/repos?type=all&amp;page=3&amp;per_page=100</a>; rel=”last”,
<a href="https://api.github.com/user/1/repos?type=all&amp;page=1&amp;per_page=100">https://api.github.com/user/1/repos?type=all&amp;page=1&amp;per_page=100</a>; rel=”first”,
<a href="https://api.github.com/user/1/repos?type=all&amp;page=1&amp;per_page=100">https://api.github.com/user/1/repos?type=all&amp;page=1&amp;per_page=100</a>; rel=”prev”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

        <span class="hljs-keyword">if</span> (!header || header.length === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> {totalPages: currentPage};
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Split parts by comma</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> parts = header.split(<span class="hljs-string">','</span>);
        <span class="hljs-keyword">var</span> links = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Parse each part into a named link</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _.each(parts, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> </span>{
            <span class="hljs-keyword">var</span> section = p.split(<span class="hljs-string">';'</span>);
            <span class="hljs-keyword">if</span> (section.length != <span class="hljs-number">2</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"section could not be split on ';'"</span>);
            }
            <span class="hljs-keyword">var</span> url = section[<span class="hljs-number">0</span>].replace(<span class="hljs-regexp">/&lt;(.*)&gt;/</span>, <span class="hljs-string">'$1'</span>).trim();
            <span class="hljs-keyword">var</span> name = section[<span class="hljs-number">1</span>].replace(<span class="hljs-regexp">/rel="(.*)"/</span>, <span class="hljs-string">'$1'</span>).trim();
            links[name] = url;
        });

        <span class="hljs-keyword">if</span> (links.last) {
            <span class="hljs-keyword">var</span> lastLinkparts = links.last.split(<span class="hljs-string">"?"</span>);
            <span class="hljs-keyword">var</span> queryString = app.ParseQueryString(lastLinkparts[<span class="hljs-number">1</span>]);
            links.totalPages = queryString.page;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If no last property is present, the current page is the last one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            links.totalPages = currentPage;
        }

        <span class="hljs-keyword">return</span> links;

    },
    processLinkResponse: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr, currentPage)</span> </span>{
        <span class="hljs-keyword">if</span> (!xhr) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">var</span> requestLink = xhr.getResponseHeader(<span class="hljs-string">'Link'</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.parseLinkHeader(requestLink, currentPage);

    },
    fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
        options = options ? _.clone(options) : {};

        <span class="hljs-keyword">var</span> complete = options.complete;
        <span class="hljs-keyword">var</span> error = options.error;
        <span class="hljs-keyword">var</span> beforeSend = options.beforeSend;
        <span class="hljs-keyword">var</span> collection = <span class="hljs-keyword">this</span>;

        options.complete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(jqXHR, textStatus)</span> </span>{
            collection.processRateLimits(jqXHR);
            <span class="hljs-keyword">if</span> (complete) complete(jqXHR, textStatus);
        };

        options.error = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, response, options)</span> </span>{
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"onError"</span>, <span class="hljs-built_in">arguments</span>);
            collection.processRateLimits(response);
            <span class="hljs-keyword">if</span> (error) error(model, response, options);
        };

        options.beforeSend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
            xhr.setRequestHeader(<span class="hljs-string">'Accept'</span>, <span class="hljs-string">'application/vnd.github.v3+json'</span>);
            <span class="hljs-keyword">if</span> (beforeSend) beforeSend(xhr);
        };

        <span class="hljs-keyword">return</span> Backbone.Collection.prototype.fetch.call(<span class="hljs-keyword">this</span>, options);
    },
    isSynced: <span class="hljs-literal">false</span>,
    fetchAllPages: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

        <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">var</span> paginationInfomation = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">var</span> pagesFetched = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">var</span> totalItemsLoaded = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"requestAllPages"</span>, <span class="hljs-keyword">this</span>);

        <span class="hljs-keyword">var</span> syncAllPages = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            that.isSynced = <span class="hljs-literal">true</span>;
            that.trigger(<span class="hljs-string">"syncAllPages"</span>, {
                pagesFetched: pagesFetched,
                totalItemsLoaded: totalItemsLoaded
            });
        };

        <span class="hljs-keyword">var</span> requestError = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection, response, options, page)</span> </span>{
            that.trigger(<span class="hljs-string">"requestAllPagesError"</span>, { totalItemsLoaded: totalItemsLoaded, response: response, page: page });
        };

        <span class="hljs-keyword">var</span> updateProgress = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fetchResults, fetchPage)</span> </span>{
            totalItemsLoaded += fetchResults.length;
            that.trigger(<span class="hljs-string">"requestAllPagesProgress"</span>, { totalRepositoryCount: totalItemsLoaded, currentPage: fetchPage, totalPages: paginationInfomation.totalPages });
        };

        that.currentXhr = that.fetch({
            remove: <span class="hljs-literal">false</span>,
            data: {page: pagesFetched},
            success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection, response, options)</span> </span>{
                that.currentXhr = <span class="hljs-literal">null</span>;
                paginationInfomation = that.processLinkResponse(options.xhr, pagesFetched);

                updateProgress(response, pagesFetched);

                <span class="hljs-keyword">if</span> (paginationInfomation.totalPages &gt; pagesFetched) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>There are other repos to load
Start paralel requests for each page, if any.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    <span class="hljs-keyword">var</span> subsequentPageLoads = [];

                    <span class="hljs-keyword">var</span> queueNextFetch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nextPageNumber)</span> </span>{
                        <span class="hljs-keyword">var</span> fetchLoader = <span class="hljs-keyword">new</span> $.Deferred();
                        <span class="hljs-keyword">var</span> subsequentPageXhr = that.fetch({
                            remove: <span class="hljs-literal">false</span>,
                            data: { page: nextPageNumber },
                            error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection, response, options)</span> </span>{
                                requestError(collection, response, options, nextPageNumber);
                                fetchLoader.reject();
                            },
                            success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection, response, options)</span> </span>{
                                updateProgress(response, nextPageNumber);
                                fetchLoader.resolve();
                            }
                        });
                        <span class="hljs-keyword">return</span> fetchLoader.promise();
                    };

                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> subsequentPageNumber = <span class="hljs-number">2</span>; subsequentPageNumber &lt;= paginationInfomation.totalPages; subsequentPageNumber++) {
                        subsequentPageLoads.push(queueNextFetch(subsequentPageNumber));
                    }

                    $.when.apply(<span class="hljs-literal">null</span>, subsequentPageLoads).done(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>All pages have  been loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        syncAllPages();
                    }).fail(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>At least one pagination call failed…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    });

                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>This is the only page of repos.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    syncAllPages();
                }

            },
            error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection, response, options)</span> </span>{
                that.currentXhr = <span class="hljs-literal">null</span>;
                requestError(collection, response, options, <span class="hljs-number">1</span>);
            }});

    },
    model: app.Repository,
    keepFirstTwenty: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length &gt; <span class="hljs-number">20</span>) {
           <span class="hljs-keyword">this</span>.remove(<span class="hljs-keyword">this</span>.tail(<span class="hljs-number">20</span>));
        }

    }
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
